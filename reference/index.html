<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
	<title>Title</title>
	<script src="./js/tween.umd.js"></script>
	<script src="./js/three.js"></script>
	<script src="./js/CSS3DCube.js"></script>
    <script src="./js/OrbitControls.js"></script>
    <script src="./js/TrackballControls.js"></script>
    <script src="./js/CSS3DRenderer.js"></script>
    <script src="./js/dat.gui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
    <style>
        body {
            margin: 0;
        }
    </style>
</head>
<body>
<div id="container" style="overflow: hidden;">

</div>
<button id='button'>change!</button>
<script>


	var camera, scene, renderer, controls;

	init();
	animate();


    /**
	 *
	 Sequence pair
	 (x, y, z)
	 kind of piece
	 - corner : sum of Absolute value of elements of sequence pair = 3 ( dimension)
	 - edge : sum of Absolute value of elements of sequence pair = 2 ( dimension - 1)
	 - center : sum of Absolute value of elements of sequence pair = 1 ( dimension - 2)
	 - core : sum of Absolute value of elements of sequence pair = 0 ( dimension - dimension)

	 sticker direction (each element)
	 -> -1 : anti direction
	 -> 1 : direction

	 -1 (back)       top(1)
	 1(right)  cube  -1(left)
	 1(front)            bottom(-1)

	 sequence pair operations
	 (F,B,R,L,U,D,F',B',R',L',U',D',F',f,b,r,l,u,d,f',b',r',l',u',d',m,e,m',e',x,y,z,x',y',z')
	 x : front, back
	 y : up, down
	 z : front, back

	 THREE DIMENSIONS ROTATION MATRICES
	 Rx
	 1 0 0
	 0 c -s
	 0 s c

	 Ry
	 c 0 s
	 0 1 0
	 -s 0 c

	 Rz
	 c -s 0
	 s c 0
	 0 0 1

	 example) R operation
	 FRU = (1, 1, 1)
	 RUD = (1, -1, 1)
	 BRU = (1, 1, -1)


	 R operation is x is 1 piece rotate 90 X-axis,
	 FRU ---> R operation ---> RUD ---> R operation ---> BRU
	 R operation matrix
	 1 0 0
	 0 0 -1
	 0 1 0

	 example) U operation
	 FRU = (1, 1, 1)
	 FLU = (-1, 1, 1)
	 BRU = (1, 1, -1)

	 U operation is y is 1 pieces rotate 90 Y-axis

	 FRU ---> U operation ---> FLU ---> U operation ---> BRU
	 U operation matrix
	 0 0 1
	 0 1 0
	 -1 0 0

	 example) R operation
	 FRU = (1, 1, 1), RU = (1, 1, 0), BRU = (1, 1, -1)
	 FR = (1, 0, 1), R = (1, 0, 0), BR = (1, 0, -1)
	 FRD = (1, -1, 1), RD = (1, -1, 0), BRD = (1, -1, -1)

	 RU ---> R operation ---> BR ---> R operation ---> RD ---> R operation ----> FR

	 R operation
	 1 0 0
	 0 0 -1
	 0 1 0

	 conclusion
	 rotate matrix multiply to all piece sequence pair
	 * */

	 async function init() {
		camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 10000);
		camera.position.x = 1761;
		camera.position.z = 1769;
		camera.position.y = 1526;

		scene = new THREE.Scene();
		const CUBE = new THREE.Group();

		scene.add(CSS3DCube.createCube(CUBE, {
			mirror : true
		}));
		scene.add(CSS3DCube.createFrontMarker());

		const operationsTag = document.createElement("div")
		operationsTag.innerHTML = ""
		Object.assign(operationsTag.style, {
				fontSize : "80px",
				width: "50px",
				height: "22px",
				display: "inline-block",
				wordWrap : "break-woard"
		})
		const operationsText = new THREE.CSS3DObject(operationsTag)
		operationsText.rotation.x = -1.575;
		operationsText.position.x = -220;
		operationsText.position.z = 1050;
		operationsText.position.y = -160;
		operationsText.name = 'text';
		scene.add(operationsText)

		/**
		 rotation test
		 **/
		// CSS3DCube.operation(CUBE, "RUR")

		renderer = new THREE.CSS3DRenderer();
		renderer.setSize(window.innerWidth, window.innerHeight);
		renderer.domElement.id = 'CUBE'
		document.getElementById("container").appendChild(renderer.domElement);

		controls = new THREE.OrbitControls(camera, renderer.domElement);
		controls.enableZoom = true;
		controls.enablePan = false;
		controls.minDistance = 500;
		controls.maxDistance = 6000;
		controls.addEventListener("change", function (e) {
			console.log("change");
		});

		window.addEventListener("resize", onWindowResize, false);

		var gui = new dat.GUI();
		gui.add(conf, "colors", ["standard", "half_bright", "full_bright", "z_bright"]).onChange((value)=>{
			CSS3DCube.changeColors(value);
        });
		gui.add(conf, "design", ["rubiks", "gan", "valk", "qiyi"]).onChange((value)=>{
			CSS3DCube.changeDesign(value);
        });
		gui.add(conf, "fitment", ["fitted", "fully_fitted"]).onChange((value)=>{
			CSS3DCube.changeFitment(value);
		})
		gui.add(conf, 'mirror').onChange(function (value) {
			CSS3DCube.changeMirror();
		});
		gui.add(conf, 'frontMarker').onChange(function (value) {
			CSS3DCube.changeFrontMarker();
		});
		gui.addColor(conf , 'stickerMarkerColor').onChange(function(value){
            console.log(value);
        })

		const animationController = CSS3DCube.animationController();
		const operationIdx = 0;
		const animationConf = {
			operationIdx : 0,
			operationString : "",
			play : async function(){
				await animationController.animateOperation(CUBE, this.operationString);
			},
			stop : function(){
				animationController.toggleAnimate();
			},
			next : async function(){
				const operations = animationController.parseOperation(this.operationString);
				console.log(operations);
				if(this.operationIdx === operations.length) return;
				await animationController.animateOperation(CUBE, operations[this.operationIdx]);
				this.operationIdx += 1;
			},
			back : async function(){
				const operations = animationController.parseOperation(this.operationString);
				if(this.operationIdx === 0) return;
				this.operationIdx -= 1;
				await animationController.animateOperation(CUBE, animationController.reverseHelper(operations[this.operationIdx]));
			},
			erase : function(){
				scene.getObjectByName("text").element.innerHTML = ""
			},
            resetCamera : function(){
	            camera.position.x = 1761;
	            camera.position.z = 1769;
	            camera.position.y = 1526;
            }
		}
		gui.add(animationConf, "operationString")
		gui.add(animationConf, 'play').name("play")
		gui.add(animationConf, 'stop').name("stop")
		gui.add(animationConf, 'next').name("next")
		gui.add(animationConf, 'back').name("back")
		gui.add(animationConf, 'erase').name("erase")
        gui.add(animationConf, 'resetCamera').name('resetCamera');
	}
	function onWindowResize() {
		camera.aspect = window.innerWidth / window.innerHeight;
		camera.updateProjectionMatrix();

		renderer.setSize(window.innerWidth, window.innerHeight);

		render();
	}

	function animate(time) {
		requestAnimationFrame(animate);
		controls.update();
		TWEEN.update(time)
		render();
	}

	function render() {
		renderer.render(scene, camera);
	}

</script>
</body>
</html>
